import { NgModuleRef, enableProdMode } from '@angular/core';
import { platformBrowserDynamic } from '@angular/platform-browser-dynamic';

import { AppModule } from './app/app.module';
import { environment } from './environments/environment';

if (environment.production) {
  enableProdMode();
}


declare global {
  interface Window {
    microApp: any
    mount: CallableFunction
    unmount: CallableFunction
    __MICRO_APP_ENVIRONMENT__: string
  }
}


let app: void | NgModuleRef<AppModule>
// ğŸ‘‡ å°†æ¸²æŸ“æ“ä½œæ”¾å…¥ mount å‡½æ•°ï¼Œå­åº”ç”¨åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œ
window.mount = () => {
  platformBrowserDynamic()
    .bootstrapModule(AppModule)
    .then((res: NgModuleRef<AppModule>) => {
      app = res
    })
    .catch(err => console.error(err))
}

// ğŸ‘‡ å°†å¸è½½æ“ä½œæ”¾å…¥ unmount å‡½æ•°ï¼Œå°±æ˜¯ä¸Šé¢æ­¥éª¤2ä¸­çš„å¸è½½å‡½æ•°
window.unmount = () => {
  // angularåœ¨éƒ¨åˆ†åœºæ™¯ä¸‹æ‰§è¡Œdestroyæ—¶ä¼šåˆ é™¤æ ¹å…ƒç´ app-rootï¼Œå¯¼è‡´åœ¨æ­¤æ¸²æŸ“æ—¶æŠ¥é”™ï¼Œæ­¤æ—¶å¯åˆ é™¤app.destroy()æ¥é¿å…è¿™ä¸ªé—®é¢˜
  app && app.destroy();
  app = undefined;
}

// å¦‚æœä¸åœ¨å¾®å‰ç«¯ç¯å¢ƒï¼Œåˆ™ç›´æ¥æ‰§è¡Œmountæ¸²æŸ“
if (!window.__MICRO_APP_ENVIRONMENT__) {
  window.mount();
}